<script>
    const chatBox = document.getElementById('chat-box');
    const codingTaskInput = document.getElementById('coding-task-input');
    const sendButton = document.getElementById('send-button');
    const addPageButton = document.getElementById('add-page-button');
    let userIp = '';
    let currentPage = 'New Page 1';
    let pageCount = 1;

    // Store chat histories in an object with page names as keys
    const chatHistories = {
        'New Page 1': []
    };

    // Fetch the user's IP address
    fetch('https://api.ipify.org?format=json')
        .then(response => response.json())
        .then(data => {
            userIp = data.ip;
        })
        .catch(error => {
            console.error('Error fetching IP address:', error);
        });

    // Helper function to append messages to the chatbox
    function appendMessage(sender, text, isCode = false) {
        const messageElement = document.createElement('div');
        messageElement.classList.add('message', sender === 'User' ? 'user' : 'ai');

        if (isCode) {
            const preElement = document.createElement('pre');
            const codeElement = document.createElement('code');
            codeElement.textContent = text;
            preElement.appendChild(codeElement);
            messageElement.appendChild(preElement);
            hljs.highlightElement(codeElement);  // Syntax highlighting for code
        } else {
            messageElement.textContent = text;
        }

        chatBox.appendChild(messageElement);
        chatBox.scrollTop = chatBox.scrollHeight; 
    }

    // Function to reapply syntax highlighting
    function reapplySyntaxHighlighting() {
        setTimeout(() => {
            document.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
        }, 100);  // Delay for DOM update
    }

    // Function to handle submission of the coding task
    function submitCodingTask() {
        const codingTask = codingTaskInput.value;

        if (codingTask) {
            appendMessage('User', codingTask);
            codingTaskInput.value = ''; 

            // Ensure chat history for the current page is updated
            chatHistories[currentPage].push({ sender: 'User', text: codingTask, isCode: false });

            fetch('https://070f-34-126-156-247.ngrok-free.app/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    ip_address: userIp,
                    message: codingTask  
                }),
            })
            .then(response => response.json())
            .then(data => {
                appendMessage('AI', data.response, true);
                chatHistories[currentPage].push({ sender: 'AI', text: data.response, isCode: true });
            })
            .catch(error => {
                console.error('Error:', error);
                appendMessage('AI', 'An error occurred while processing your request.');
            });
        }
    }

    // Attach event listeners for sending messages
    sendButton.addEventListener('click', submitCodingTask);
    codingTaskInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            submitCodingTask();
        }
    });

    // Tab Functionality: Create New Tab and Switch Between Tabs
    addPageButton.addEventListener('click', () => {
        pageCount++;
        const newTab = document.createElement('div');
        newTab.classList.add('tab');
        newTab.innerHTML = `<input type="text" value="New Page ${pageCount}" class="tab-title" disabled />`;
        document.getElementById('tab-container').insertBefore(newTab, addPageButton);
        chatHistories[`New Page ${pageCount}`] = [];  // Create an empty chat history for the new page

        newTab.addEventListener('click', () => {
            setActiveTab(newTab, `New Page ${pageCount}`);
        });
    });

    function setActiveTab(tab, pageName) {
        const activeTab = document.querySelector('.tab.active');
        if (activeTab) {
            activeTab.classList.remove('active');
        }

        tab.classList.add('active');
        currentPage = pageName;
        loadChatHistory(pageName);
    }

    function loadChatHistory(pageName) {
        chatBox.innerHTML = '';  // Clear current chat box
        const history = chatHistories[pageName] || [];  // Get chat history for the selected page
        history.forEach(msg => {
            appendMessage(msg.sender, msg.text, msg.isCode);
        });

        reapplySyntaxHighlighting();
    }

    const firstTab = document.getElementById('new-page-1');
    firstTab.addEventListener('click', () => {
        setActiveTab(firstTab, 'New Page 1');
    });
</script>
